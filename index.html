<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Softfund (STFD) — Devnet Test</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<style>
:root{--bg:#0f0f1a;--card:#121226;--accent:#00d4ff;--text:#e6eefc;--muted:#9fb0c8}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,system-ui,Arial;background:linear-gradient(135deg,#0f0f1a,#0b1230);color:var(--text);padding:18px;min-height:100vh}
.container{max-width:920px;margin:20px auto;background:var(--card);border-radius:14px;padding:18px;border:1px solid rgba(0,212,255,0.06);box-shadow:0 12px 30px rgba(0,0,0,0.5)}
.row{display:flex;gap:20px;flex-wrap:wrap}
.left{flex:0 0 360px}.right{flex:1}
h1{text-align:center;margin-bottom:8px;font-weight:700}
.hero img{width:100%;border-radius:10px;display:block}
.controls{margin-top:12px}
.btn{background:linear-gradient(90deg,#00d4ff,#00ffa0);border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;color:#000}
.small{font-size:0.9rem;color:var(--muted)}
.addr{font-family:monospace;color:#7ff}
.qty-btn{width:44px;height:44px;border-radius:10px;border:1px solid rgba(0,212,255,0.08);background:rgba(0,212,255,0.02);color:var(--accent);font-size:20px;cursor:pointer}
#quantity{display:inline-block;width:48px;text-align:center;font-weight:800;color:#fff}
.progress{height:10px;background:rgba(255,255,255,0.04);border-radius:6px;overflow:hidden;margin-top:12px}
.progress-bar{height:100%;background:linear-gradient(90deg,#00d4ff,#00ff88);width:0%;transition:width .8s}
.gallery{margin-top:16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
.tile{background:rgba(255,255,255,0.02);border-radius:8px;padding:8px;text-align:center}
.tile img{width:100%;height:90px;object-fit:cover;border-radius:6px}
.sold{color:#ff6b6b;font-weight:800;font-size:1.05rem;margin-top:12px}
.input{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--text);margin-top:8px}
.copy-btn{margin-left:8px;padding:6px 8px;border-radius:8px;background:#00d4ff;color:#000;border:none;cursor:pointer}
.canvas{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:9999}
.status{margin-top:10px;font-weight:700;color:#a8f0b0}
.note{font-size:0.85rem;color:#aab;margin-top:8px}
</style>
</head>
<body>
<div class="container">
  <h1>Softfund (STFD)</h1>
  <div class="row">
    <div class="left">
      <div class="hero">
        <!-- hero image uses CID that ends with y4le as you asked -->
        <img id="heroImg" src="https://gateway.lighthouse.storage/ipfs/bafkreidstjrabmghkjqwjcpct24g67flpybxs6gd7vpcg724upwibpy4le" alt="hero image">
      </div>

      <div class="controls">
        <div class="small">Price per STFD: <strong>$3.20</strong></div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
          <button class="btn" id="connectBtn">Connect Wallet (Phantom)</button>
          <div id="connected" class="small">Not connected</div>
        </div>

        <div style="margin-top:12px">
          <div class="small">Quantity</div>
          <div style="display:flex;align-items:center;gap:8px;margin-top:6px">
            <button class="qty-btn" id="dec">−</button>
            <div id="quantity">1</div>
            <button class="qty-btn" id="inc">+</button>
            <div style="margin-left:12px" class="small">max 10</div>
          </div>
        </div>

        <div style="margin-top:12px" class="small">
          Total: $<span id="totalUSD">3.200</span> USD ≈ <span id="totalSOL">—</span> SOL
          <div id="rate" class="small" style="margin-top:6px"></div>
        </div>

        <div style="margin-top:12px">
          <button id="mintBtn" class="btn">MINT (Devnet)</button>
        </div>

        <div style="margin-top:12px" class="small">Recipient (Devnet): <span id="treasury" class="addr">3GM4KD2PJvmqx1MeMgT65Gkq7qqWu9bo9TpTcGgpyTPc</span>
          <button class="copy-btn" id="copyTreasury">Copy</button>
        </div>

        <div class="progress"><div id="progressBar" class="progress-bar"></div></div>
        <div id="counter" class="small" style="margin-top:8px"></div>

        <div id="proofSection" style="display:none;margin-top:12px">
          <input id="proofFile" type="file" class="input">
          <input id="proofEmail" type="email" class="input" placeholder="Your email">
          <button id="sendProof" class="btn" style="margin-top:8px">Send Proof</button>
        </div>

        <div id="status" class="status"></div>
        <div class="note">Open this page inside Phantom (Devnet) or host on HTTPS and open with Phantom extension on desktop.</div>
      </div>
    </div>

    <div class="right">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Recent mints</div>
        <div class="small">Cap: <strong id="cap">5000</strong></div>
      </div>

      <div id="soldOut" class="sold" style="display:none">SOLD OUT — 5000 MINTED</div>

      <div class="gallery" id="gallery" aria-live="polite"></div>
    </div>
  </div>
</div>

<canvas id="confettiCanvas" class="canvas"></canvas>

<!-- include solana web3 as IIFE/UMD to avoid module import/cors issues -->
<script src="https://unpkg.com/@solana/web3.js@1.72.0/lib/index.iife.min.js"></script>

<script>
/* Wait for DOM to be ready */
document.addEventListener('DOMContentLoaded', () => {
  // sanity log
  console.log('Softfund page loaded');

  // Using the IIFE build which exposes `solanaWeb3`
  const { Connection, PublicKey, SystemProgram, Transaction, LAMPORTS_PER_SOL } = window.solanaWeb3 || window.solanaWeb3 || {};

  if (!Connection) {
    console.error('Solana web3 not found (IIFE).');
    alert('Library load failed. Try hosting the page (HTTPS) and reload.');
    return;
  }

  // CONFIG (devnet)
  const TREASURY = '3GM4KD2PJvmqx1MeMgT65Gkq7qqWu9bo9TpTcGgpyTPc';
  const PRICE_USD = 3.20;
  const TOTAL_CAP = 5000;
  let minted = parseInt(localStorage.getItem('sf_minted_dev') || '0');
  let quantity = 1;
  let SOL_PRICE = 150.0; // fallback
  const METADATA = [
    "bafkreidstjrabmghkjqwjcpct24g67flpybxs6gd7vpcg724upwibpy4le",
    "bafkreibiip2mn32hvppk4fpfcbob4rszyiamru5mazdpcbanihfylhnami",
    "bafkreidxd6q6vtpwboxr5eokewalr3ie7xmxjocny5m2ft66fayo5cd6im",
    "bafkreid7v5q6uetszdev5tmlrf2ma43tjfbova7gc7epuzt2lnbhcc4ijm",
    "bafkreidiimwvc36ekicyuxugmo7wcsdhvye3l3fz4l34lvs3lf44tsrqra",
    "bafkreibiip2mn32hvppk4fpfcbob4rszyiamru5mazdpcbanihfylhnami",
    "bafkreihhs2kunfn4dvwundezfqyksisjlqlrsqm77rypz6c7dmhwu3uy5y",
    "bafkreidxd6q6vtpwboxr5eokewalr3ie7xmxjocny5m2ft66fayo5cd6im",
    "bafkreifakecid000000000000000000000000000000000000000001",
    "bafkreifakecid000000000000000000000000000000000000000002",
    "bafkreifakecid000000000000000000000000000000000000000003",
    "bafkreifakecid000000000000000000000000000000000000000004",
    "bafkreifakecid000000000000000000000000000000000000000005",
    "bafkreifakecid000000000000000000000000000000000000000006",
    "bafkreifakecid000000000000000000000000000000000000000007",
    "bafkreifakecid000000000000000000000000000000000000000008",
    "bafkreifakecid000000000000000000000000000000000000000009",
    "bafkreifakecid000000000000000000000000000000000000000010",
    "bafkreifakecid000000000000000000000000000000000000000011",
    "bafkreifakecid000000000000000000000000000000000000000012"
  ];
  const STORAGE = { records: 'sf_records_dev', nextIdx: 'sf_nextidx_dev', minted: 'sf_minted_dev' };

  // DOM refs
  const connectBtn = document.getElementById('connectBtn');
  const connectedEl = document.getElementById('connected');
  const decBtn = document.getElementById('dec');
  const incBtn = document.getElementById('inc');
  const quantityEl = document.getElementById('quantity');
  const totalUSDEl = document.getElementById('totalUSD');
  const totalSOLEl = document.getElementById('totalSOL');
  const rateEl = document.getElementById('rate');
  const mintBtn = document.getElementById('mintBtn');
  const progressBar = document.getElementById('progressBar');
  const counterEl = document.getElementById('counter');
  const galleryEl = document.getElementById('gallery');
  const heroImg = document.getElementById('heroImg');
  const soldOutEl = document.getElementById('soldOut');
  const proofSection = document.getElementById('proofSection');
  const copyTreasury = document.getElementById('copyTreasury');
  const statusEl = document.getElementById('status');

  const connection = new Connection('https://api.devnet.solana.com', 'confirmed');

  let provider = null;
  let records = JSON.parse(localStorage.getItem(STORAGE.records) || "[]");
  let nextIndex = parseInt(localStorage.getItem(STORAGE.nextIdx) || '0');

  // attach button listeners (guaranteed after DOM loaded)
  decBtn.addEventListener('click', () => { quantity = Math.max(1, quantity - 1); renderQuantity(); updatePrice(); });
  incBtn.addEventListener('click', () => { quantity = Math.min(10, quantity + 1); renderQuantity(); updatePrice(); });
  copyTreasury.addEventListener('click', () => { navigator.clipboard.writeText(TREASURY).then(()=>alert('Copied treasury')); });

  connectBtn.addEventListener('click', async () => {
    if (window.solana && window.solana.isPhantom) {
      try {
        await window.solana.connect();
        provider = window.solana;
        connectedEl.textContent = 'Connected: ' + provider.publicKey.toString();
        console.log('Connected to phantom', provider.publicKey.toString());
      } catch (e) {
        console.warn('connect cancelled', e);
        alert('Connect cancelled');
      }
    } else if (window.backpack) {
      try {
        await window.backpack.connect();
        provider = window.backpack;
        connectedEl.textContent = 'Connected: ' + provider.publicKey.toString();
      } catch (e) {
        console.warn('backpack connect failed', e);
      }
    } else {
      alert('No Solana wallet detected. Open this page inside Phantom (Devnet) or use the Phantom extension for desktop and host the page on HTTPS.');
    }
  });

  async function tryAutoConnect() {
    if (window.solana && window.solana.isPhantom) {
      try {
        await window.solana.connect({ onlyIfTrusted: true });
        provider = window.solana;
        connectedEl.textContent = 'Connected: ' + provider.publicKey.toString();
        console.log('auto-connected');
      } catch (e) { /* not trusted */ }
    }
  }

  mintBtn.addEventListener('click', async () => {
    if (minted >= TOTAL_CAP) { alert('Sold out'); return; }
    const totalUSD = PRICE_USD * quantity;
    const totalSOL = totalUSD / SOL_PRICE;
    const lamports = Math.round(totalSOL * LAMPORTS_PER_SOL);

    if (provider && provider.publicKey) {
      if (!confirm(`Send ${totalSOL.toFixed(6)} SOL (devnet) to treasury? Approve in your wallet.`)) return;
      mintBtn.disabled = true; mintBtn.textContent = 'Waiting for approval...'; statusEl.textContent = '';
      try {
        const fromPubkey = provider.publicKey;
        const toPubkey = new PublicKey(TREASURY);
        const tx = new Transaction().add(SystemProgram.transfer({ fromPubkey, toPubkey, lamports }));
        tx.feePayer = fromPubkey;
        tx.recentBlockhash = (await connection.getRecentBlockhash()).blockhash;

        // sign & send
        const signed = await provider.signTransaction(tx);
        const raw = signed.serialize();
        const sig = await connection.sendRawTransaction(raw);
        await connection.confirmTransaction(sig, 'confirmed');

        // update state & gallery
        const recs = JSON.parse(localStorage.getItem(STORAGE.records) || "[]");
        const assigned = [];
        for (let i = 0; i < quantity; i++) {
          if (minted >= TOTAL_CAP) break;
          const cid = METADATA[nextIndex % METADATA.length];
          const id = recs.length + 1;
          recs.push({ id, cid, tx: sig, ts: Date.now() });
          assigned.push({ id, cid });
          nextIndex = (nextIndex + 1) % METADATA.length;
          minted++;
        }
        localStorage.setItem(STORAGE.records, JSON.stringify(recs));
        localStorage.setItem(STORAGE.nextIdx, String(nextIndex));
        localStorage.setItem(STORAGE.minted, String(minted));
        records = recs;
        renderGallery(); updateUI();
        statusEl.textContent = 'Confirmed — tx: ' + sig;
        fireConfetti();
        proofSection.style.display = 'block';
        if (assigned.length) {
          heroImg.style.opacity = 0.3;
          setTimeout(()=>{ heroImg.src = `https://gateway.lighthouse.storage/ipfs/${assigned[assigned.length-1].cid}`; heroImg.style.opacity = 1; }, 350);
        }
      } catch (err) {
        console.error('tx error', err);
        alert('Transaction failed or cancelled: ' + (err?.message || err));
      } finally {
        mintBtn.disabled = false; mintBtn.textContent = 'MINT (Devnet)';
        updateUI();
      }
    } else {
      if (!confirm('No wallet connected. Simulate mint instead?')) return;
      const recs = JSON.parse(localStorage.getItem(STORAGE.records) || "[]");
      const assigned = [];
      for (let i=0;i<quantity;i++) {
        if (minted >= TOTAL_CAP) break;
        const cid = METADATA[nextIndex % METADATA.length];
        const id = recs.length + 1;
        recs.push({ id, cid, tx: null, ts: Date.now() });
        assigned.push({ id, cid });
        nextIndex = (nextIndex + 1) % METADATA.length;
        minted++;
      }
      localStorage.setItem(STORAGE.records, JSON.stringify(recs));
      localStorage.setItem(STORAGE.nextIdx, String(nextIndex));
      localStorage.setItem(STORAGE.minted, String(minted));
      records = recs;
      renderGallery(); updateUI();
      statusEl.textContent = 'Simulated assign';
      fireConfetti();
      proofSection.style.display = 'block';
    }
  });

  document.getElementById('sendProof').addEventListener('click', () => {
    const f = document.getElementById('proofFile').files[0];
    const e = document.getElementById('proofEmail').value;
    if (!f || !e) return alert('file & email required');
    alert('Proof recorded (demo)');
    proofSection.style.display = 'none';
  });

  // helper UI functions
  function renderQuantity() { quantityEl.textContent = quantity; }
  function updateUI() {
    renderQuantity();
    counterEl.textContent = `${minted} people have minted`;
    progressBar.style.width = Math.min(100,(minted/TOTAL_CAP)*100) + '%';
    if (minted >= TOTAL_CAP) { soldOutEl.style.display = 'block'; mintBtn.disabled = true; } else { soldOutEl.style.display = 'none'; mintBtn.disabled = false; }
    updatePrice();
  }
  function updatePrice() {
    const totalUSD = PRICE_USD * quantity;
    const totalSOL = totalUSD / SOL_PRICE;
    totalUSDEl.textContent = totalUSD.toFixed(3);
    totalSOLEl.textContent = totalSOL.toFixed(6);
    rateEl.textContent = `(1 SOL = $${SOL_PRICE.toFixed(2)})`;
    document.getElementById('treasury').textContent = TREASURY;
  }
  function renderGallery(){
    galleryEl.innerHTML = '';
    const show = records.slice(-30).reverse();
    if (show.length === 0) {
      galleryEl.innerHTML = '<div class="small" style="color:#9fb0c8">No mints yet</div>';
      return;
    }
    for (const r of show) {
      const tile = document.createElement('div'); tile.className='tile';
      const img = document.createElement('img'); img.src = `https://gateway.lighthouse.storage/ipfs/${r.cid}`; img.alt = `#${r.id}`;
      const label = document.createElement('div'); label.textContent = `#${r.id}`; label.style.marginTop='6px'; label.style.fontWeight='700';
      tile.appendChild(img); tile.appendChild(label);
      galleryEl.appendChild(tile);
    }
  }
  function fireConfetti(){
    const canvas = document.getElementById('confettiCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = innerWidth; canvas.height = innerHeight;
    const parts = [];
    for (let i=0;i<120;i++) parts.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height*0.2,dx:(Math.random()-0.5)*6,dy:Math.random()*6+2,s:Math.random()*6+3,color:`hsl(${Math.random()*360},80%,60%)`});
    let raf;
    function loop(){ ctx.clearRect(0,0,canvas.width,canvas.height); for(const p of parts){ ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.s,p.s); p.x+=p.dx; p.y+=p.dy; if(p.y>canvas.height) p.y=-10; } raf=requestAnimationFrame(loop); }
    loop(); setTimeout(()=>{ cancelAnimationFrame(raf); ctx.clearRect(0,0,canvas.width,canvas.height); },3500);
  }

  // fetch price
  (async function fetchSOLPrice(){
    try {
      const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd');
      const j = await r.json();
      if (j?.solana?.usd) SOL_PRICE = j.solana.usd;
    } catch(e) { console.warn('price fetch failed', e); }
    updateUI();
  })();

  // try autoconnect and initial render
  tryAutoConnect();
  renderGallery();
  updateUI();
  console.log('Softfund Devnet page initialized');
});
</script>
</body>
</html>